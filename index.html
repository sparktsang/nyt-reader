<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal NYT Extractor (Pro Max)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; color: #333; }
        h1 { font-size: 1.2rem; color: #555; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 12px; margin-bottom: 10px; box-sizing: border-box; }
        button { background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:hover { background-color: #333; }
        #output { margin-top: 30px; background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); white-space: pre-wrap; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.1rem; line-height: 1.6; display: none; }
        .error { color: red; font-weight: bold; margin-top: 10px; font-family: monospace; }
        .success { color: green; font-weight: bold; margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>

    <h1>NYT Source Extractor (Supports Standard, Live & Interactive)</h1>
    <textarea id="sourceInput" placeholder="Paste all content in 'view-source:' here..."></textarea>
    <button onclick="processHTML()">Extract Article</button>
    <div id="status"></div>
    <div id="output"></div>

    <script>
        function processHTML() {
            const html = document.getElementById('sourceInput').value;
            const statusDiv = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            
            statusDiv.innerText = "";
            statusDiv.className = "";
            outputDiv.style.display = 'none';
            outputDiv.innerText = "";

            if (!html) {
                statusDiv.innerText = "PLEASE INPUT THE SOURCE CODE";
                statusDiv.className = "error";
                return;
            }

            try {
                const result = extractContent(html);
                outputDiv.innerText = result.text;
                outputDiv.style.display = 'block';
                statusDiv.innerText = "EXTRACTED; MODE: " + result.mode;
                statusDiv.className = "success";
            } catch (e) {
                statusDiv.innerText = "EXTRACTION FAILED: " + e.message;
                statusDiv.className = "error";
                console.error(e);
            }
        }

        function extractContent(htmlSource) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlSource, "text/html");
            let output = [];

            // =========================================================
            // 戰術 A: 解析 LD+JSON (專門應付 Live Blog)
            // =========================================================
            try {
                const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
                for (let script of scripts) {
                    try {
                        const json = JSON.parse(script.innerText);
                        if (json['@type'] === 'LiveBlogPosting' && json.liveBlogUpdate) {
                            output.push("The New York Times (Live Blog)");
                            output.push("");
                            output.push(json.headline || "");
                            output.push(json.description || "");
                            output.push("========================================");
                            output.push("");

                            const updates = Array.isArray(json.liveBlogUpdate) ? json.liveBlogUpdate : [json.liveBlogUpdate];
                            updates.sort((a, b) => new Date(b.datePublished) - new Date(a.datePublished));

                            updates.forEach(update => {
                                const timeStr = formatDate(update.datePublished, true);
                                output.push(`[${timeStr}]`);
                                if (update.headline) output.push(update.headline);
                                output.push("");
                                output.push(update.articleBody || "");
                                output.push("");
                                output.push("----------------------------------------");
                                output.push("");
                            });
                            return { text: output.join("\n"), mode: "Live Blog" };
                        }
                    } catch (e) { continue; }
                }
            } catch (e) { console.log("Strategy A failed"); }


            // =========================================================
            // 戰術 B: 解析 window.__preloadedData (專門應付普通文章)
            // =========================================================
            const allScripts = doc.querySelectorAll('script');
            let standardArticleFound = false;

            for (let script of allScripts) {
                let content = script.innerHTML;
                if (content.includes('window.__preloadedData')) {
                    // 安全提取 JSON 大括號部分
                    let startIndex = content.indexOf('{');
                    let endIndex = content.lastIndexOf('}');
                    
                    if (startIndex !== -1 && endIndex !== -1) {
                        let jsonStr = content.substring(startIndex, endIndex + 1);
                        
                        // 【關鍵修復】: 只替換作為 JSON value 的 undefined，不影響正常文字
                        jsonStr = jsonStr.replace(/(:\s*)undefined/g, '$1null');

                        try {
                            const data = JSON.parse(jsonStr);
                            const article = data?.initialData?.data?.article;
                            
                            // 檢查是否真的包含內文 (Interactive 模式沒有 sprinkledBody.content)
                            if (article && article.sprinkledBody && article.sprinkledBody.content) {
                                standardArticleFound = true;
                                
                                output.push("The New York Times");
                                output.push("");
                                output.push(article.headline?.default || "");
                                if(article.summary) output.push(article.summary);
                                output.push("");
                                
                                // 抓取 Header 資訊
                                let bylineText = "";
                                let locationText = "";
                                const contentBlocks = article.sprinkledBody.content;
                                
                                let headerBlock = contentBlocks.find(b => b.__typename && b.__typename.includes("Header"));
                                if (headerBlock) {
                                    if (headerBlock.byline?.bylines) bylineText = headerBlock.byline.bylines[0]?.renderedRepresentation || "";
                                    if (headerBlock.role) locationText = headerBlock.role.map(r => r.text).join("");
                                }
                                if (!bylineText && article.bylines) bylineText = article.bylines[0]?.renderedRepresentation || "";

                                if (bylineText) output.push(bylineText);
                                if (locationText) output.push(locationText);
                                if (article.firstPublished) output.push(formatDate(article.firstPublished));
                                output.push("");

                                contentBlocks.forEach(block => {
                                    const type = block.__typename;
                                    if (type && type.includes("Header")) return;
                                    
                                    if (type === "ParagraphBlock") {
                                        const text = block.content.map(seg => seg.text).join("");
                                        if (text) { output.push(text); output.push(""); }
                                    } else if (["Heading1Block", "Heading2Block", "Heading3Block"].includes(type)) {
                                        const text = block.content.map(seg => seg.text).join("");
                                        if (text) { output.push(""); output.push(text); output.push(""); }
                                    }
                                });
                                
                                while(output.length > 0 && output[output.length-1] === "") output.pop();
                                output.push(""); output.push(article.url || "");
                                
                                return { text: output.join("\n"), mode: "Standard Article" };
                            }
                        } catch (e) { 
                            console.log("Strategy B parse skipped a block."); 
                        }
                    }
                }
            }


            // =========================================================
            // 戰術 C: 暴力擷取 HTML DOM (專門應付 Interactive / Scrollytelling)
            // =========================================================
            if (!standardArticleFound) {
                output = []; // 清空

                // 從 meta 標籤抓取元數據
                const title = doc.querySelector('meta[property="og:title"]')?.content || doc.title || "";
                const desc = doc.querySelector('meta[property="og:description"]')?.content || "";
                const url = doc.querySelector('meta[property="og:url"]')?.content || "";
                let byline = doc.querySelector('meta[name="byl"]')?.content || "";
                const date = doc.querySelector('meta[property="article:published_time"]')?.content || "";

                // 如果 Meta 沒抓到 Byline，試著從畫面上抓
                if (!byline) {
                    const bylineEl = doc.querySelector('.g-byline, .byline-container');
                    if (bylineEl) byline = bylineEl.innerText.replace(/\n/g, ' ').trim();
                }

                output.push("The New York Times (Interactive Feature)");
                output.push("");
                if (title) output.push(title);
                if (desc) output.push(desc);
                output.push("");
                if (byline) output.push(byline);
                if (date) output.push(formatDate(date));
                output.push("");

                // 鎖定主要內容區塊
                const container = doc.querySelector('article') || doc.querySelector('main') || doc.body;
                
                // 抓取所有標題與段落
                const elements = container.querySelectorAll('h2, h3, p');
                let lastText = "";

                elements.forEach(el => {
                    const className = (el.className || "").toLowerCase();
                    
                    // 過濾掉圖片說明、版權、筆記、隱藏文字等 UI 雜訊
                    if (
                        className.includes('caption') || 
                        className.includes('credit') || 
                        className.includes('note') || 
                        className.includes('byline') ||
                        className.includes('visually-hidden') ||
                        className.includes('hidden')
                    ) {
                        return; 
                    }

                    const text = el.innerText.trim();
                    if (!text) return;
                    
                    // 過濾系統預設字眼
                    const ignoreList = ["Advertisement", "SKIP ADVERTISEMENT", "Share full article", "Read in Spanish", "Read 841 comments"];
                    if (ignoreList.some(item => text.includes(item)) || text.startsWith("Supported by")) {
                        return;
                    }

                    // 避免重複抓取 (有時 HTML 嵌套會導致父子元素文字重複)
                    if (text !== lastText) {
                        // 如果是標題，加個標記凸顯
                        if (el.tagName.match(/^H[1-6]$/i) || className.includes('subhed')) {
                            output.push("");
                            output.push("=== " + text + " ===");
                            output.push("");
                        } else {
                            output.push(text);
                            output.push("");
                        }
                        lastText = text;
                    }
                });

                output.push("");
                output.push(url);

                if (output.length > 10) { // 確保有抓到東西
                    return { text: output.join("\n"), mode: "Interactive Feature (DOM Extraction)" };
                }
            }

            throw new Error("EXTRACTION FAILED; FORMAT INCOMPATIBLE OR SOURCE CODE INCOMPLETE");
        }

        // 日期格式化工具
        function formatDate(isoString, includeTime = false) {
            if (!isoString) return "";
            try {
                const dateObj = new Date(isoString);
                const estTime = new Date(dateObj.getTime() - (5 * 3600000));
                const optionsDate = { year: 'numeric', month: 'short', day: 'numeric' };
                let dateStr = estTime.toLocaleDateString('en-US', optionsDate).replace(/([a-zA-Z]+)/, "$1.");
                if (includeTime) {
                    const optionsTime = { hour: 'numeric', minute: '2-digit', hour12: true };
                    let timeStr = estTime.toLocaleTimeString('en-US', optionsTime);
                    return `${dateStr}, ${timeStr} ET`;
                }
                return dateStr;
            } catch (e) {
                return isoString;
            }
        }
    </script>
</body>
</html>
