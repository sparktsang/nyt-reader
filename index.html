<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal NYT Extractor (Enhanced)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f5f5f5; color: #333; }
        h1 { font-size: 1.2rem; color: #555; }
        textarea { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-family: monospace; font-size: 12px; margin-bottom: 10px; box-sizing: border-box; }
        button { background-color: #000; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:hover { background-color: #333; }
        #output { margin-top: 30px; background: #fff; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); white-space: pre-wrap; font-family: Georgia, 'Times New Roman', Times, serif; font-size: 1.1rem; line-height: 1.6; display: none; }
        .error { color: red; font-weight: bold; margin-top: 10px; font-family: monospace; }
        .update-divider { border-top: 2px solid #000; margin: 40px 0 20px 0; }
        .time-label { font-family: sans-serif; font-weight: bold; font-size: 0.9rem; color: #666; display: block; margin-bottom: 5px; }
        .headline { font-weight: bold; font-size: 1.3rem; margin-bottom: 10px; display: block; }
    </style>
</head>
<body>

    <h1>NYT Source Extractor (LD+JSON Support)</h1>
    <textarea id="sourceInput" placeholder="Paste all content in 'view-source:' here..."></textarea>
    <button onclick="processHTML()">Extract Article</button>
    <div id="status" class="error"></div>
    <div id="output"></div>

    <script>
        function processHTML() {
            const html = document.getElementById('sourceInput').value;
            const statusDiv = document.getElementById('status');
            const outputDiv = document.getElementById('output');
            
            statusDiv.innerText = "";
            outputDiv.style.display = 'none';
            outputDiv.innerText = "";

            if (!html) {
                statusDiv.innerText = "PLEASE INPUT THE SOURCE CODE";
                return;
            }

            try {
                const text = extractContent(html);
                outputDiv.innerText = text;
                outputDiv.style.display = 'block';
            } catch (e) {
                statusDiv.innerText = "EXTRACTION FAILED: " + e.message;
            }
        }

        function extractContent(htmlSource) {
            let output = [];

            // -------------------------------------------------------------
            // 策略 A: 優先嘗試解析 LD+JSON (Schema.org)
            // 這是 Live Blog 儲存完整 articleBody 的地方
            // -------------------------------------------------------------
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlSource, "text/html");
                const scripts = doc.querySelectorAll('script[type="application/ld+json"]');

                for (let i = 0; i < scripts.length; i++) {
                    try {
                        const json = JSON.parse(scripts[i].innerText);
                        
                        // 檢查是否為 LiveBlogPosting
                        if (json['@type'] === 'LiveBlogPosting' && json.liveBlogUpdate) {
                            
                            output.push("The New York Times (Live Blog)");
                            output.push("");
                            output.push(json.headline || "");
                            output.push(json.description || "");
                            output.push("========================================");
                            output.push("");

                            const updates = Array.isArray(json.liveBlogUpdate) ? json.liveBlogUpdate : [json.liveBlogUpdate];
                            
                            // 按時間倒序
                            updates.sort((a, b) => new Date(b.datePublished) - new Date(a.datePublished));

                            updates.forEach(update => {
                                const timeStr = formatDate(update.datePublished, true);
                                const headline = update.headline || "";
                                const body = update.articleBody || ""; // 這裡就是你肉眼看到的那些長文

                                output.push(`[${timeStr}]`);
                                if (headline) output.push(headline);
                                output.push("");
                                output.push(body); // 直接輸出 articleBody
                                output.push("");
                                output.push("----------------------------------------");
                                output.push("");
                            });

                            return output.join("\n"); // 成功找到，直接返回
                        }
                    } catch (e) {
                        continue;
                    }
                }
            } catch (e) {
                console.log("LD+JSON parsing failed, falling back...");
            }


            // -------------------------------------------------------------
            // 策略 B: 如果策略 A 失敗，回退到舊的 window.__preloadedData 方法
            // (適用於普通文章)
            // -------------------------------------------------------------
            const regex = /window\.__preloadedData\s*=\s*(\{[\s\S]*?\});/;
            const match = htmlSource.match(regex);

            if (match) {
                let jsonStr = match[1].replace(/":undefined/g, '":null').replace(/undefined/g, 'null');
                const data = JSON.parse(jsonStr);
                
                const article = data?.initialData?.data?.article;
                
                if (article) {
                    const headline = article.headline?.default || "";
                    const summary = article.summary || "";
                    const url = article.url || "";
                    
                    // 抓取 Header
                    let bylineText = "";
                    const contentBlocks = article.sprinkledBody?.content || [];
                    let headerBlock = contentBlocks.find(b => b.__typename && b.__typename.includes("Header"));
                    if (headerBlock && headerBlock.byline?.bylines) {
                        bylineText = headerBlock.byline.bylines[0]?.renderedRepresentation || "";
                    }

                    output.push("The New York Times");
                    output.push("");
                    output.push(headline);
                    output.push(summary);
                    output.push("");
                    output.push(bylineText);
                    output.push(formatDate(article.firstPublished));
                    output.push("");

                    contentBlocks.forEach(block => {
                        const type = block.__typename;
                        if (type && type.includes("Header")) return;
                        
                        if (type === "ParagraphBlock") {
                            const text = block.content.map(seg => seg.text).join("");
                            if (text) { output.push(text); output.push(""); }
                        } else if (["Heading1Block", "Heading2Block", "Heading3Block"].includes(type)) {
                            const text = block.content.map(seg => seg.text).join("");
                            if (text) { output.push(""); output.push(text); output.push(""); }
                        }
                    });
                    output.push(""); output.push(url);
                    return output.join("\n");
                }
            }

            throw new Error("EXTRACTION FAILED; FORMAT INCOMPATIBLE OR SOURCE CODE INCOMPLETE");
        }

        // 日期格式化 (UTC -> 美東時間)
        function formatDate(isoString, includeTime = false) {
            if (!isoString) return "";
            try {
                const dateObj = new Date(isoString);
                const estTime = new Date(dateObj.getTime() - (5 * 3600000));
                
                const optionsDate = { year: 'numeric', month: 'short', day: 'numeric' };
                let dateStr = estTime.toLocaleDateString('en-US', optionsDate).replace(/([a-zA-Z]+)/, "$1.");
                
                if (includeTime) {
                    const optionsTime = { hour: 'numeric', minute: '2-digit', hour12: true };
                    let timeStr = estTime.toLocaleTimeString('en-US', optionsTime);
                    return `${dateStr}, ${timeStr} ET`;
                }
                return dateStr;
            } catch (e) {
                return isoString;
            }
        }
    </script>
</body>
</html>
